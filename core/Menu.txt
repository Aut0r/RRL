{=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=
RRL - Reflection Resource Library
Menu routines.

---------------------------------------------------------

 * function IsMenuOpen: Boolean;
     By: Timer
 * function IsMenuTabbed: Boolean;
     By: Timer
 * function GetMenuCount: Integer;
     By: Timer
 * function GetMenuText: TStringArray;
     By: Timer
 * function GetMenuIndex(Text: string): Integer;
     By: Timer
 * function ClickMenuIndex(Index: Integer): Boolean;
     By: Timer
 * function Interact(Option: string): Boolean;
     By: Timer
=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=}

{
This work is licensed under the Creative Commons Attribution-NonCommercial-NoDerivs 3.0 Unported License.
To view a copy of this license, visit http://creativecommons.org/licenses/by-nc-nd/3.0/
or send a letter to Creative Commons, 171 Second Street, Suite 300, San Francisco, California, 94105, USA.

Copyright (C) 2010 - 2011 by Joe Haddad, all rights reserved.
This file is part of the RRL project (https://github.com/Timer/RRL).

For extended permissions please contact me by E-Mail, Timer150@Gmail.com.
}

function IsMenuOpen: Boolean;
begin
  Result := SmartGetFieldBoolean(0, hook_MenuOpen);
end;

function IsMenuTabbed: Boolean;
begin
  Result := SmartGetFieldBoolean(0, hook_MenuTabbed);
end;

function GetMenuCount: Integer;
begin
  Result := SmartGetFieldInt(0, hook_MenuCount);
end;

function GetMenuText: TStringArray;
var
  Nodes, Head, Next, Count, JavaString, Last: LongInt;
  Item: string;
begin
  try
    Nodes := SmartGetFieldObject(0, hook_MenuNodeList);
    Head := SmartGetFieldObject(Nodes, hook_Node_Head);
    if (IsMenuTabbed) then
      Next := Head
    else
      Next := SmartGetFieldObject(Head, hook_Node_Next);
    Count := GetMenuCount;
    SetLength(Result, Count);
    repeat
      JavaString := SmartGetFieldObject(Next, hook_Menu_Action);
      if (JavaString = 0) then
      begin
        SmartFreeObject(JavaString);
        Break;
      end;
      Item := GetString(JavaString);
      SmartFreeObject(JavaString);
      JavaString := SmartGetFieldObject(next, hook_Menu_Option);
      Item := Item + ' ' + GetString(JavaString);
      SmartFreeObject(JavaString);
      Result[Count - 1] := RemoveJunk(Item);
      Last := Next;
      Next := SmartGetFieldObject(Last, hook_Node_Next);
      SmartFreeObject(Last);
      Dec(Count);
    until (Count <= 0);
    SmartFreeObject(Next);
    SmartFreeObject(Head);
    SmartFreeObject(Nodes);
  except
    try
      SmartFreeObject(Next);
    except
    end;
    try
      SmartFreeObject(Last);
    except
    end;
    try
      SmartFreeObject(Head);
    except
    end;
    try
      SmartFreeObject(Nodes);
    except
    end;
    WriteLn('GetMenuText failed.. looping again [possible infinite loop].');
    Wait(50);
    Result := GetMenuText;
  end;
end;

function GetMenuIndex(Text: string): Integer;
var
  Menu: TStringArray;
  i: Integer;
begin
  Menu := GetMenuText;
  Result := -1;
  if (High(Menu) > -1) then
    for i := 0 to High(Menu) do
      if (Pos(Lowercase(Text), Lowercase(Menu[i])) <> 0) then
      begin
        Result := i;
        Exit;
      end;
end;

function ClickMenuIndex(Index: Integer): Boolean;
var
  AllItems: TStringArray;
  Item: string;
  xOff, yOff: Integer;
  P: TPoint;
  T, MC: LongInt;
begin
  mc := 1;
  AllItems := GetMenuText;
  if (Length(AllItems) < Index) then
  begin
    Result := False;
    Exit;
  end;
  if (Index = -1) then
  begin
    Result := False;
    Exit;
  end;
  if (not IsMenuOpen) then
  begin
    {$IFDEF SIMBA}
      ClickMouse2(False);
    {$ELSE}
      GetMousePos(xOff, yOff);
      Mouse(xOff, yOff, 0, 0, False);
    {$ENDIF}
    T := GetSystemTime;
    while (GetSystemTime - T < 1000) and (not IsMenuOpen) do
      Wait(50);
    if (not IsMenuOpen) then
      Exit;
    AllItems := GetMenuText;
    if (Length(AllItems) < Index) then
    begin
      Result := False;
      Exit;
    end;
  end;
  Item := AllItems[Index];
  P := Point(SmartGetFieldInt(0, hook_MenuX), SmartGetFieldInt(0, hook_MenuY));
  if (IsMenuTabbed) then
  begin
    //We can't click sub-menus yet!
    Result := False;
  end else
  begin
    xOff := RandomRange(4, 4 + Random(Length(Item) * 4 - 4));
    yOff := 21 + (16 * index) + RandomRange(2, 10);
    Mouse(P.x + xOff, P.y + yOff, 0, 0, True);
    Wait(RandomRange(80, 100));
    Result := not IsMenuOpen;
    Exit;
  end;
  while (IsMenuOpen) do
  begin
    MMouse(Random(MSX2), Random(MSY2), 0, 0);
    Wait(RandomRange(100, 200));
  end;
end;

function Interact(Option: string): Boolean;
var
  Index{$IFNDEF SIMBA}, x, y{$ENDIF}: Integer;
  AllItems: TStringArray;
  T: LongInt;
begin
  Index := GetMenuIndex(Option);
  if (Index = -1) then
  begin
    Result := False;
    Exit;
  end;
  AllItems := GetMenuText;
  if (Length(AllItems) < Index) then
  begin
    Result := False;
    Exit;
  end;
  if (not IsMenuOpen) then
  begin
    {$IFDEF SIMBA}
      ClickMouse2(False);
    {$ELSE}
      GetMousePos(x, y);
      Mouse(x, y, 0, 0, False);
    {$ENDIF}
    T := GetSystemTime;
    while (GetSystemTime - T < 1000) and (not IsMenuOpen) do
      Wait(50);
    if (not IsMenuOpen) then
      Exit;
    AllItems := GetMenuText;
    if (Length(AllItems) < Index) then
    begin
      Result := False;
      Exit;
    end;
  end;
  Result := ClickMenuIndex(Index);
end;